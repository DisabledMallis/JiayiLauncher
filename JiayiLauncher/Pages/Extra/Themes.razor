@page "/Themes"
@using System.Net.Http
@using JiayiLauncher.Settings
@using JiayiLauncher.Shared.Components.Mods
@using JiayiLauncher.Utils
@using Newtonsoft.Json
@using JiayiLauncher.Shared.Components.Themes
@using static JiayiLauncher.Shared.Components.Mods.JiayiFilter
<h3>Themes</h3>

<div class="find-tools">
    <span class="material-symbols-sharp">search</span>
    <JiayiTextBox Placeholder="Search themes" @ref="_searchBox" Changed="StateHasChanged" />

    <div class="separator"></div>

    <span class="material-symbols-sharp">filter_list</span>
    <p class="filter-by">Filter by:</p>
    @foreach (var raw_tag in PublicTheme.RAW_TAGS)
    {
        <JiayiFilter Changed="() => FilterChanged(raw_tag)">@raw_tag</JiayiFilter>
    }

    <div class="separator"></div>

    <span class="material-symbols-sharp refresh" onclick="LoadThemes">refresh</span>

    <p class="invisible-normalizer">invisible</p>
</div>

<div class="themes">
    @* Local themes *@
    <ul class="theme-list">
        @if (local_themes?.Count > 0)
        {
            _localSearchResults = 0;
            foreach (var theme in local_themes)
            {
                if (!theme.Name.Contains(_searchBox?.Value ?? "", StringComparison.OrdinalIgnoreCase)) continue;

                _localSearchResults++;
                <JiayiLocalThemeCard @key="theme.Name" Theme="@theme" ChangeApplying="(e) => _applying = e" Applying="@_applying" />
            }
        }
    </ul>

    <hr class="divider" />

    @* Public themes *@
    <ul class="theme-list">
        @if (themes?.Length > 0)
        {
            _searchResults = 0;
            foreach (var theme in themes)
            {
                if (raw_tags.Count > 0)
                {
                    if (!raw_tags.All(tag => theme.RawTags.Any(sourceTag => string.Equals(tag, sourceTag, StringComparison.OrdinalIgnoreCase)))) continue;
                }

                // TODO: Searching tags array searchs DIRECTLY for that string
                if (!theme.Name.Contains(_searchBox?.Value ?? "", StringComparison.OrdinalIgnoreCase) && theme.Tags.Where(x => x.StartsWith(_searchBox?.Value ?? "", StringComparison.OrdinalIgnoreCase)).Count() <= 0 && !theme.Author.Contains(_searchBox?.Value ?? "", StringComparison.OrdinalIgnoreCase)) continue;

                _searchResults++;
                <JiayiThemeCard @key="theme.Name" Theme="@theme" ChangeApplying="(e) => _applying = e" Applying="@_applying" />
            }
        }
    </ul>
    @if (_searchResults == 0 && themes?.Length > 0)
    {
        <p style="text-align: center; margin-top: 0;">No results found.</p>
    }

    <button class="add-button" @onclick="CreateNewTheme">
        <span class="material-symbols-sharp">add</span>
    </button>
</div>

@code {
    private PublicTheme[] themes;
    private List<LocalTheme> local_themes;

    [CascadingParameter]
    public IModalService ModalService { get; set; } = default!;

    private bool _applying = false;
    private int _localSearchResults;
    private int _searchResults;

    private List<string> raw_tags = new();
    // refs
    private JiayiTextBox? _searchBox;

    protected override async Task OnInitializedAsync()
    {
        LoadThemes();

        await base.OnInitializedAsync();
    }

    private void LoadThemes()
    {
        themes = PublicTheme.GetAllThemes()!;
        local_themes = LocalTheme.GetAllThemes().ToList();
        StateHasChanged();
    }

    private void FilterChanged(string raw_tag)
    {
        if (raw_tags.Contains(raw_tag))
        {
            raw_tags.Remove(raw_tag);
        }
        else
        {
            raw_tags.Add(raw_tag);
        }

        StateHasChanged();
    }

    private async void CreateNewTheme()
    {
        var parameters = new ModalParameters();

        var modal = ModalService.Show<NewTheme>("New Theme", parameters);
        await modal.Result;

        LoadThemes();
    }
}

